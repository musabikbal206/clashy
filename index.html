<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CR: Synced Multiplayer</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Titan+One&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap');

        :root { --blue:#4789CE; --red:#EB4847; --hud-bg:#2b2018; }
        * { box-sizing:border-box; touch-action:none; user-select:none; font-family:'Titan One',cursive; }
        body { margin:0; background:#111; overflow:hidden; width:100%; height:100%; }
        #app { position:relative; width:100%; height:100%; max-width:550px; margin:0 auto; background:#333; box-shadow:0 0 50px #000; overflow:hidden; }

        /* Status Bar */
        #status-bar { position:absolute; top:0; left:0; width:100%; height:20px; background:#000; color:#888; font-size:10px; text-align:center; line-height:20px; z-index:1000; font-family:sans-serif; }
        .connected { color: #4f4 !important; font-weight:bold; }
        
        /* Menu */
        #menu-layer { position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg,#1f3b73,#162447); z-index:300; display:flex; flex-direction:column; }
        .menu-header { padding:30px; text-align:center; }
        .game-title { font-size:40px; color:#ffce00; text-shadow:0 4px 0 #b35900; }
        .btn-container { padding:20px; display:flex; gap:10px; margin-top:auto; background:rgba(0,0,0,0.4); }
        .btn { flex:1; padding:15px; border:none; border-radius:10px; font-size:18px; cursor:pointer; border-bottom:5px solid rgba(0,0,0,0.3); }
        .btn-sol { background:#ffce00; color:#5c3a00; }
        .btn-mul { background:#4789CE; color:#fff; }

        /* Lobby */
        #lobby { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#111; z-index:400; flex-direction:column; padding:10px; color:#fff; }
        .qr-box { background:#fff; padding:10px; border-radius:8px; margin:10px auto; display:inline-block; }
        .cam-box { width:100%; max-width:300px; height:220px; background:#000; margin:10px auto; border:2px solid #ffce00; position:relative; }
        video { width:100%; height:100%; object-fit:cover; }
        textarea { width:100%; height:60px; background:#222; color:#fff; border:1px solid #555; }

        /* Game */
        #game-view { display:none; width:100%; height:100%; position:relative; }
        canvas { display:block; width:100%; height:100%; background:#5D9E44; }
        
        /* HUD */
        #hud { position:absolute; bottom:0; left:0; width:100%; height:200px; background:var(--hud-bg); display:flex; flex-direction:column; padding:10px; border-top:4px solid #1a120d; }
        .hud-top { height:30px; display:flex; align-items:center; margin-bottom:5px; }
        .elixir { flex:1; height:20px; background:#111; border:2px solid #555; border-radius:10px; position:relative; }
        .elixir-fill { height:100%; width:50%; background:#d946ef; transition:width 0.1s linear; }
        .cards { flex:1; display:flex; gap:5px; }
        .card { flex:1; background:#7a8c99; border:2px solid #222; border-radius:6px; position:relative; display:flex; align-items:center; justify-content:center; flex-direction:column; cursor:pointer; }
        .card.selected { transform:translateY(-10px); border-color:#fff; z-index:10; }
        .card.disabled { filter:grayscale(1); opacity:0.5; }
        
        /* Result */
        #result { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:500; display:none; flex-direction:column; align-items:center; justify-content:center; color:#fff; }
        .hidden { display:none !important; }
    </style>
</head>
<body>

<div id="app">
    <div id="status-bar">Offline</div>

    <div id="menu-layer">
        <div class="menu-header">
            <div class="game-title">CLASH<br>ROYALE</div>
            <div style="color:#aaa; font-size:12px; margin-top:5px">Synced Edition</div>
        </div>
        <div class="btn-container">
            <button class="btn btn-sol" onclick="APP.start('single')">SOLO</button>
            <button class="btn btn-mul" onclick="LOBBY.open()">VS FRIEND</button>
        </div>
    </div>

    <div id="lobby">
        <div class="menu-header" style="padding:10px"><div class="game-title" style="font-size:20px">CONNECT</div></div>
        
        <div id="setup-btns" style="display:flex; gap:10px; padding:10px">
            <button class="btn btn-mul" onclick="LOBBY.host()">I AM HOST</button>
            <button class="btn btn-sol" onclick="LOBBY.join()">I AM GUEST</button>
        </div>

        <div id="conn-ui" class="hidden" style="text-align:center">
            <div id="step-txt" style="color:#ffce00; font-size:18px; margin:5px">Generating...</div>
            
            <div id="qr-display" class="hidden">
                <div class="qr-box"><div id="qrcode"></div></div>
                <div style="font-size:10px; color:#aaa">Scan this on other device</div>
                <button class="btn btn-sol" style="padding:5px; font-size:12px; margin-top:5px" onclick="LOBBY.copy()">Copy Code</button>
                <textarea id="copy-target" style="opacity:0; height:1px"></textarea>
            </div>

            <div id="cam-display" class="hidden" style="margin-top:10px">
                <div class="cam-box"><video id="vid" playsinline></video></div>
                <div style="font-size:10px; color:#aaa">Scan opponent's code</div>
                <button class="btn btn-mul" style="padding:5px; font-size:12px; margin-top:5px" onclick="LOBBY.togglePaste()">Or Paste Code</button>
                <div id="paste-area" class="hidden" style="margin-top:5px">
                    <textarea id="paste-in" placeholder="Paste code here"></textarea>
                    <button class="btn btn-sol" onclick="LOBBY.pasteConnect()">Connect</button>
                </div>
            </div>
        </div>
        <button class="btn" style="background:#333; color:#fff; margin-top:auto" onclick="LOBBY.close()">BACK</button>
    </div>

    <div id="game-view">
        <canvas id="canvas"></canvas>
        <div id="hud">
            <div class="hud-top">
                <div style="color:#fff; font-size:12px; margin-right:5px">Elixir</div>
                <div class="elixir"><div id="elixir-fill" class="elixir-fill"></div></div>
                <div id="elixir-num" style="color:#fff; width:20px; text-align:right">5</div>
            </div>
            <div class="cards" id="hand"></div>
        </div>
    </div>

    <div id="result">
        <h1 id="res-txt">VICTORY</h1>
        <button class="btn btn-sol" onclick="location.reload()">MENU</button>
    </div>
</div>
<canvas id="qr-canv" style="display:none"></canvas>

<script>
/* --- CONFIG & DATA --- */
const CFG = { W:0, H:0, PH:0, RY:0 }; // Width, Height, PlayHeight, RiverY
const CARDS = {
    KNIGHT: {cost:3, hp:900, dmg:90, speed:45, range:20, icon:'âš”ï¸', type:'unit', count:1},
    ARCHER: {cost:3, hp:300, dmg:60, speed:55, range:140, icon:'ðŸ¹', type:'unit', count:2},
    GIANT:  {cost:5, hp:2600, dmg:150, speed:25, range:20, icon:'ðŸ—¿', type:'unit', count:1},
    SKEL:   {cost:1, hp:60, dmg:50, speed:70, range:20, icon:'ðŸ’€', type:'unit', count:3},
    FIRE:   {cost:4, dmg:350, radius:70, icon:'ðŸ”¥', type:'spell', color:'#f40'},
    ARRW:   {cost:3, dmg:120, radius:110, icon:'âž´', type:'spell', color:'#fa0'},
    WIZ:    {cost:5, hp:600, dmg:140, speed:45, range:120, icon:'ðŸ§™', type:'unit', count:1},
    PEKKA:  {cost:7, hp:2200, dmg:450, speed:30, range:20, icon:'ðŸ¤–', type:'unit', count:1}
};
const DECK = Object.keys(CARDS);

/* --- NETWORK ENGINE (Robust) --- */
const NET = {
    peer: null, chan: null, role: null, active: false,
    
    init: function(role) {
        this.role = role; this.active = true;
        this.peer = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
        
        // ICE Handler
        this.peer.onicecandidate = e => {
            if(!e.candidate) {
                const data = LZString.compressToBase64(JSON.stringify(this.peer.localDescription));
                LOBBY.showQR(data);
                if(role === 'host') LOBBY.startCam(); // Host waits for Answer
            }
        };

        if(role === 'host') {
            this.chan = this.peer.createDataChannel("game");
            this.setupChan();
            this.peer.createOffer().then(o => this.peer.setLocalDescription(o));
        } else {
            this.peer.ondatachannel = e => { this.chan = e.channel; this.setupChan(); };
            LOBBY.startCam(); // Guest waits for Offer
        }
    },

    setupChan: function() {
        this.chan.onopen = () => {
            document.getElementById('status-bar').innerHTML = "ðŸŸ¢ CONNECTED";
            document.getElementById('status-bar').className = "connected";
            LOBBY.close();
            APP.start(this.role);
        };
        this.chan.onmessage = e => {
            if(GAME) GAME.onNetMessage(JSON.parse(e.data));
        };
    },

    receiveCode: function(str) {
        try {
            const desc = JSON.parse(LZString.decompressFromBase64(str));
            this.peer.setRemoteDescription(new RTCSessionDescription(desc));
            if(this.role === 'guest') {
                this.peer.createAnswer().then(a => this.peer.setLocalDescription(a));
                LOBBY.step2(); // Guest switches to showing QR
            }
            return true;
        } catch(e) { return false; }
    },

    send: function(msg) {
        if(this.chan && this.chan.readyState === 'open') this.chan.send(JSON.stringify(msg));
    }
};

/* --- LOBBY UI --- */
const LOBBY = {
    stream: null, scanning: false,
    open: function() { document.getElementById('lobby').style.display = 'flex'; },
    close: function() { 
        this.stopCam(); document.getElementById('lobby').style.display = 'none'; 
    },
    host: function() { 
        document.getElementById('setup-btns').classList.add('hidden');
        document.getElementById('conn-ui').classList.remove('hidden');
        document.getElementById('step-txt').innerText = "1. HOST: Generating...";
        NET.init('host'); 
    },
    join: function() { 
        document.getElementById('setup-btns').classList.add('hidden');
        document.getElementById('conn-ui').classList.remove('hidden');
        document.getElementById('step-txt').innerText = "1. GUEST: Scan Host";
        NET.init('guest'); 
    },
    showQR: function(data) {
        document.getElementById('qr-display').classList.remove('hidden');
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {text:data, width:160, height:160});
        document.getElementById('copy-target').value = data;
    },
    step2: function() {
        // Guest Logic: After scanning host, show answer
        this.stopCam();
        document.getElementById('cam-display').classList.add('hidden');
        document.getElementById('step-txt').innerText = "2. GUEST: Show this to Host";
    },
    copy: function() {
        document.getElementById('copy-target').select(); document.execCommand('copy'); alert("Copied!");
    },
    togglePaste: function() { document.getElementById('paste-area').classList.remove('hidden'); },
    pasteConnect: function() {
        const c = document.getElementById('paste-in').value;
        if(NET.receiveCode(c)) {
            if(NET.role === 'host') document.getElementById('step-txt').innerText = "Connecting...";
        } else alert("Invalid Code");
    },
    startCam: function() {
        document.getElementById('cam-display').classList.remove('hidden');
        const v = document.getElementById('vid');
        navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>{
            this.stream=s; v.srcObject=s; v.play(); this.scanning=true; requestAnimationFrame(this.tick.bind(this));
        }).catch(e=>alert("Cam failed. Use Paste."));
    },
    stopCam: function() { this.scanning=false; if(this.stream)this.stream.getTracks().forEach(t=>t.stop()); },
    tick: function() {
        if(!this.scanning) return;
        const v=document.getElementById('vid'), c=document.getElementById('qr-canv'), ctx=c.getContext('2d');
        if(v.readyState===v.HAVE_ENOUGH_DATA) {
            c.width=v.videoWidth; c.height=v.videoHeight; ctx.drawImage(v,0,0);
            const idata=ctx.getImageData(0,0,c.width,c.height);
            const code=jsQR(idata.data,idata.width,idata.height);
            if(code && NET.receiveCode(code.data)) {
                if(NET.role==='host') document.getElementById('step-txt').innerText="Connecting...";
            }
        }
        requestAnimationFrame(this.tick.bind(this));
    }
};

/* --- GAME LOGIC --- */
const APP = {
    start: function(mode) {
        document.getElementById('menu-layer').style.display = 'none';
        document.getElementById('game-view').style.display = 'block';
        window.GAME = new Game(mode);
    }
};

class Game {
    constructor(mode) {
        this.mode = mode; // 'single', 'host', 'guest'
        this.isGuest = (mode === 'guest');
        this.canv = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        
        this.elixir = 5;
        this.hand = [];
        this.fillHand();
        
        this.entities = [];
        this.running = true;
        this.lastT = 0;
        
        this.towers = [];
        this.initWorld();
        
        // Input
        this.canv.addEventListener('mousedown', e => this.input(e));
        this.canv.addEventListener('touchstart', e => this.input(e.touches[0]));
        
        requestAnimationFrame(t => this.loop(t));
        
        // Start Loop
        setInterval(() => { if(this.running && this.elixir<10) this.elixir+=0.1; this.ui(); }, 300);
        if(mode==='single') setInterval(() => this.ai(), 3000);
    }

    resize() {
        const p = this.canv.parentElement;
        this.canv.width = CFG.W = p.clientWidth;
        this.canv.height = CFG.H = p.clientHeight;
        CFG.PH = CFG.H - 200; // Play Height above HUD
        CFG.RY = CFG.PH / 2;  // River Y
    }

    fillHand() {
        while(this.hand.length < 4) this.hand.push(DECK[Math.floor(Math.random()*DECK.length)]);
    }

    initWorld() {
        // Red is Top (Logic Y < River), Blue is Bottom (Logic Y > River)
        const w = CFG.W, h = CFG.PH;
        // Red Towers (Opponent for Host, Self for Guest)
        this.addEnt('TOWER', w*0.25, h*0.2, 'red');
        this.addEnt('TOWER', w*0.75, h*0.2, 'red');
        this.addEnt('KING',  w*0.5,  h*0.1, 'red');
        // Blue Towers (Self for Host, Opponent for Guest)
        this.addEnt('TOWER', w*0.25, h*0.8, 'blue');
        this.addEnt('TOWER', w*0.75, h*0.8, 'blue');
        this.addEnt('KING',  w*0.5,  h*0.9, 'blue');
    }

    addEnt(type, x, y, team, data={}) {
        this.entities.push({type, x, y, team, hp:1000, maxHp:1000, ...data});
    }

    input(e) {
        const rect = this.canv.getBoundingClientRect();
        let rawX = e.clientX - rect.left;
        let rawY = e.clientY - rect.top;

        // If clicking HUD, handle selection
        if(rawY > CFG.PH) {
            const idx = Math.floor((rawX / CFG.W) * 4);
            if(idx < this.hand.length) this.sel = idx;
            this.ui();
            return;
        }

        if(this.sel === undefined || this.elixir < CARDS[this.hand[this.sel]].cost) return;

        // COORDINATE TRANSFORMATION
        // We must convert "Screen Click" to "Logic Coordinates"
        // Logic: Blue is Bottom (High Y), Red is Top (Low Y).
        
        let logicX = rawX;
        let logicY = rawY;

        if(this.isGuest) {
            // Guest sees Red at Bottom.
            // Guest clicks Bottom (High Y). Logic needs to be Top (Low Y).
            logicX = CFG.W - rawX;
            logicY = CFG.PH - rawY;
        }

        const cardKey = this.hand[this.sel];
        const card = CARDS[cardKey];
        const team = this.isGuest ? 'red' : 'blue';

        // Check placement validity
        // Blue can place Y > River. Red can place Y < River.
        const valid = (team === 'blue' && logicY > CFG.RY) || (team === 'red' && logicY < CFG.RY);
        
        if(valid || card.type === 'spell') {
            this.spawn(cardKey, logicX, logicY, team);
            if(this.mode !== 'single') NET.send({key:cardKey, x:logicX, y:logicY, team});
            
            this.elixir -= card.cost;
            this.hand[this.sel] = DECK[Math.floor(Math.random()*DECK.length)];
            this.sel = undefined;
            this.ui();
        }
    }

    spawn(key, x, y, team) {
        const c = CARDS[key];
        if(c.type === 'unit') {
            for(let i=0; i<c.count; i++) {
                this.addEnt('UNIT', x+Math.random()*20-10, y+Math.random()*20-10, team, {
                    key:key, hp:c.hp, dmg:c.dmg, speed:c.speed, range:c.range, icon:c.icon, target:null, atkT:0
                });
            }
        } else {
            // Spell effect
            this.entities.push({type:'FX', x, y, time:0, color:c.color, radius:c.radius});
            // Damage logic omitted for brevity, focusing on sync
        }
    }

    onNetMessage(msg) {
        this.spawn(msg.key, msg.x, msg.y, msg.team);
    }

    ai() {
        if(Math.random()>0.7) this.spawn('KNIGHT', CFG.W*0.5, CFG.PH*0.2, 'red');
    }

    loop(t) {
        const dt = (t - this.lastT)/1000;
        this.lastT = t;
        if(this.running) this.update(dt);
        this.draw();
        requestAnimationFrame(t => this.loop(t));
    }

    update(dt) {
        // Simple Battle Logic
        this.entities.forEach(e => {
            if(e.type === 'UNIT') {
                // Find Target
                let closest = null, dist = 9999;
                this.entities.forEach(t => {
                    if(t.team !== e.team && (t.type==='UNIT'||t.type==='TOWER'||t.type==='KING')) {
                        const d = Math.hypot(e.x-t.x, e.y-t.y);
                        if(d < dist) { dist=d; closest=t; }
                    }
                });

                if(closest) {
                    if(dist <= e.range) {
                        // Attack
                        e.atkT -= dt;
                        if(e.atkT <= 0) { closest.hp -= e.dmg; e.atkT = 1; }
                    } else {
                        // Move
                        const angle = Math.atan2(closest.y - e.y, closest.x - e.x);
                        e.x += Math.cos(angle) * e.speed * dt;
                        e.y += Math.sin(angle) * e.speed * dt;
                    }
                } else if(e.team === 'blue') e.y -= e.speed*dt; // Default move up
                else e.y += e.speed*dt; // Default move down
            }
        });

        // Cleanup Dead
        this.entities = this.entities.filter(e => e.hp === undefined || e.hp > 0);
        this.entities = this.entities.filter(e => e.type !== 'FX' || e.time < 0.5);
    }

    draw() {
        this.ctx.fillStyle = '#4BA636';
        this.ctx.fillRect(0,0,CFG.W,CFG.H);
        
        this.ctx.save();
        
        // VIEW TRANSFORMATION
        if(this.isGuest) {
            // Guest sees world rotated 180 around CENTER OF PLAYFIELD
            this.ctx.translate(CFG.W/2, CFG.PH/2);
            this.ctx.rotate(Math.PI);
            this.ctx.translate(-CFG.W/2, -CFG.PH/2);
        }

        // River
        this.ctx.fillStyle = '#3FA7D6';
        this.ctx.fillRect(0, CFG.RY-20, CFG.W, 40);

        // Draw Entities
        this.entities.forEach(e => {
            if(e.type === 'UNIT') {
                this.ctx.font = '20px serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(e.icon, e.x, e.y);
                // HP Bar
                this.ctx.fillStyle = e.team==='blue'?'#4f4':'#f44';
                this.ctx.fillRect(e.x-10, e.y-20, 20*(e.hp/CARDS[e.key].hp), 3);
            } else if(e.type.includes('TOWER') || e.type === 'KING') {
                this.ctx.fillStyle = e.team==='blue'?'#24d':'#d42';
                this.ctx.fillRect(e.x-20, e.y-20, 40, 40);
                this.ctx.fillStyle = '#fff';
                this.ctx.fillText(e.hp, e.x, e.y);
            }
        });

        this.ctx.restore();
    }

    ui() {
        document.getElementById('elixir-fill').style.width = (this.elixir/10)*100+'%';
        document.getElementById('elixir-num').innerText = Math.floor(this.elixir);
        
        const div = document.getElementById('hand');
        div.innerHTML = '';
        this.hand.forEach((k, i) => {
            const c = CARDS[k];
            const el = document.createElement('div');
            el.className = `card ${this.sel===i?'selected':''} ${this.elixir<c.cost?'disabled':''}`;
            el.innerHTML = `<div style="font-size:24px">${c.icon}</div><div style="font-size:10px;color:#fff">${c.cost}</div>`;
            el.onclick = (e) => { e.stopPropagation(); this.sel = i; this.ui(); };
            div.appendChild(el);
        });
    }
}
</script>
</body>
</html>



